events { worker_connections 1024; }

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile      on;
    keepalive_timeout 65;


    server {
        listen 80;
        server_name annuairedid-fe.qcdigitalhub.com;

        location /static/ { alias /static/; expires 7d;}

        location /media/ { alias /media/; expires 7d;}

        # Serve production DID Documents: https://HOST/{org}/{user}/{app}/did.json
        location ~ ^/([a-zA-Z0-9-]+)/([a-zA-Z0-9-]+)/([a-zA-Z0-9-]+)/did\.json$ {
            # Map URI to files under /var/www/dids/public
            root /var/www/dids/.well-known;
            # e.g. /var/www/dids/public/{org}/{user}/{app}/did.json
            try_files $uri =404;

            # Headers
            add_header Content-Type "application/did+json";
            add_header Access-Control-Allow-Origin "*" always;
            add_header Cache-Control "public, max-age=60";
        }


        # Serve draft DID Documents: https://HOST/draft/{org}/{user}/{app}/did.json
        # TODO: protect this path with auth (basic/JWT via auth_request)
        location ~ ^/draft/([a-zA-Z0-9-]+)/([a-zA-Z0-9-]+)/([a-zA-Z0-9-]+)/did\.json$ {
            root /var/www/dids;
            # -> /var/www/dids/draft/{org}/{user}/{app}/did.json
            try_files $uri =404;

            add_header Content-Type "application/did+json";
            add_header Access-Control-Allow-Origin "*" always;
            add_header Cache-Control "no-store";
        }



        # Backend API
        location /api/ {
          proxy_pass http://annuaire-backend:8899;
          proxy_http_version 1.1;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /admin/ {
          proxy_pass http://annuaire-backend:8899;
          proxy_http_version 1.1;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Frontend
        location / {
          proxy_pass http://annuaire-frontend:3000;
          proxy_http_version 1.1;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
        }

        # Cache Next.js static assets
        location ~* ^/_next/static/ {
          proxy_pass http://annuaire-frontend:3000;
          add_header Cache-Control "public, max-age=31536000, immutable";
        }

        client_max_body_size 10m;
        gzip on;
        gzip_types text/plain text/css application/json application/javascript application/wasm image/svg+xml;
    }

}
